<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes" name="viewport"/>
    <title>eNahar</title>
    <link rel="stylesheet" href="../resources/css/fore.css"/>
    <link rel="stylesheet" href="../resources/css/eNahar.css"/>

<!--    <script type="module" src="http://localhost:8090/index.js"></script>-->
    <script type="module" src="../resources/script/fore-dev.js"/>
    <style>
        .grid {
        	display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
	        width: 100%;
        }
        .gridh {
        	display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
	        width: 100%;
        }
        .card{
            border:thin solid;
            padding:0.3rem;
            margin:0.3rem 0;
            border-radius: 5px;
            background: white;

        }
        label{
            display: block;
        }
        [repeat-index]{
            background: rgba(255,255,255,0.5);
        }

        .wrapper{
            width:auto;
            max-width: 100%;
        }
        fx-control{
            width: 100%;
            position:relative;
        }
        fx-repeat{
            position:relative;
        }
        fx-repeatitem{
            display: block;
            min-width: 200px;
            position:relative;
        }
        .header{
            /*border-bottom: thin solid white;*/
            padding: 1rem;
        }
        .header input{
            background: transparent;
        }

        #schedule &gt; fx-repeatitem{
            /*background: rgba(255,255,255,0.5);*/
            border:thin solid white;
            position: relative;
            min-width: 250px;
            padding:0.5rem 0.25rem;
        }
        #schedule .header &gt; fx-output{
            width: calc(100% - 5rem);
        }
        .subheader{
            font-size: 0.9rem;
            font-weight: 700;
            margin-top:1rem;
        }
        .event{
            width: 80%;
            display: block;
        }
        #event fx-repeatitem{
            display: grid;
            grid-template-columns: 100px auto 20px;
            align-items: center;
        }
        .inline {
            display: inline;
        }
        .iconbtn{
            grid-area: icon;
        }
        .iconbtn{
            position: relative;
            right: 0rem;
        }
        .iconbtn button:hover{
            background: red;
            color: white;
        }
        .del{
            float: right;
        }
        .iconbtn button{
            border-radius: 50%;
            border:none;
            color:black;
            background: white;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <!-- for accessability adding a 'role' and 'title' to make it a landmark -->
    <fx-fore id="eNahar" title="eNahar app" role="form">
        <!-- When Fore is ready, it receives the 'ready' event and we can savely interact with the UI, setting
        the focus to the control with id 'task'. -->
        <fx-setfocus control="provider" event="ready"/>

        <!-- listening on document for an 'logged-in' event, storing the username and loading the todos of the user.  -->
        <fx-action event="logged-in" target="#document">
            <fx-setvalue ref="instance()/@user" value="event('user')"/>
            <fx-update/>
            <fx-send submission="s-load-names"/>
            <fx-send submission="s-schedule-names"/>
        </fx-action>

        <!-- listening on document for an 'logged-out' event, output a message and reset username -->
        <fx-action event="logged-out" target="#document">
            <fx-message>logged out {event('user')}</fx-message>
            <fx-setvalue ref="instance()/@user"/>
        </fx-action>
        <fx-message event="ready">admin ready: index of r-sched: {index('r-sched')}</fx-message>
        <fx-model>

            <fx-instance id="default">
                <data user="">
                    <today>2024-07-22</today>
                    <is-old>0</is-old>
                    <greetings>Hello Universe</greetings>
                </data>
            </fx-instance>
            
            <fx-instance id="i-ical-list">
                <data>
                </data>
            </fx-instance>
            
            <fx-instance id="i-schedule-list">
                <data>
                </data>
            </fx-instance>            

            <fx-instance id="i-cals">
                <data>
                </data>
            </fx-instance>



            <fx-instance id="selected">
                <data>
                    <selected/>
                    <profession>arzt</profession>
                    <schedule-type/>
                    <schedule-ref/>
                    <show-all-agendas>false</show-all-agendas>
                    <show-all-cals>false</show-all-cals>
                    <isspecial>false</isspecial>
                </data>
            </fx-instance>

            <fx-bind ref="instance('selected')">
                <!--
                <fx-bind ref="show-all-agendas" type="xs:boolean"/>
                <fx-bind ref="show-all-cals" type="xs:boolean"/>
                -->
            </fx-bind>

            <!-- the helper instance contains some nodes being used at runtime and is the structure is loaded from
            an external xml file. -->
            <fx-instance id="i-calInfos" src="/exist/apps/eNahar/cal/cal-infos.xml"/>

            <dx-instance id="helper" src="helper.xml"/>
            
            <!-- submissions send http requests. This one loads all ical owners with a GET request and
            replace our ical-list instance with the response data. -->
            <fx-submission id="s-load-names" url="../ICal?_elements=id,owner&amp;group=arzt&amp;active=true" method="get" replace="instance" targetref="instance('i-ical-list')">
                <fx-message event="submit-error">could not load ical owners</fx-message>
                <fx-message event="submit-done">ical owners loaded</fx-message>
            </fx-submission>
             <fx-submission id="s-schedule-names" url="../Schedule?_elements=id,type,name,ff&amp;active=true&amp;type={instance('selected')/schedule-type}" method="get" replace="instance" targetref="instance('i-schedule-list')">
                <fx-message event="submit-error">could not load schedules</fx-message>
                <fx-message event="submit-done">schedules loaded</fx-message>
            </fx-submission>
            
            <!-- this one loads ical of selected owner with a GET request and replace our i-cal instance with the response data. -->
            <fx-submission id="s-read-ical" url="../ICal/{instance('selected')/selected}" method="get" replace="instance" targetref="instance('i-cals')">
                <fx-message event="submit-error">could not load ical</fx-message>
                <fx-message event="submit-done">ical loaded</fx-message>
            </fx-submission>

            <!-- this submission saves the current ical with a PUT request to the ICal API. -->
            <fx-submission id="s-save" url="../ICal" method="put" replace="none" nonrelevant="keep">
                <fx-message event="submit-error">ical for {instance('i-cals')/owner/display/@value} could not stored</fx-message>
                <fx-message event="submit-done">ical for {instance('i-cals')/owner/display/@value} stored</fx-message>
            </fx-submission>
            
            <fx-instance id="i-control">
                <data>
                    <dirty>false</dirty>
                    <save-trigger/>
                    <has-schedule/>
                    <has-agenda/>
                    <has-event/>
                    <no-schedule/>
                    <no-agenda/>
                    <no-event/>  
                    <has-rdate/>
                </data>
            </fx-instance>

            <fx-bind ref="instance('i-control')">

                <fx-bind ref="./show-all-agendas" type="xs:boolean"/>

                <fx-bind ref="./save-trigger" relevant="instance('i-control')/dirty = 'true'"/>

                <fx-bind ref="./has-schedule" relevant="exists(instance('i-cals')/schedule)"/>
                <fx-bind ref="./has-agenda" relevant="exists(instance('i-cals')/schedule[index('r-sched')]/agenda)"/>
                <fx-bind ref="./has-event" relevant="exists(instance('i-cals')/schedule[index('r-sched')]/agenda[index('r-agenda')]/event)"/>
                <fx-bind ref="./has-rdate" relevant="exists(instance('i-cals')/schedule[index('r-sched')]/agenda[index('r-agenda')]/event[index('r-event')]/rdate/date/@value)"/>
            </fx-bind>

        </fx-model>
        <nav> 
            <ul> 
                <li>
                            <a class="active" href="#">eNaharPro Admin</a>
                        </li> 
                <li>
                            <a href="#">Menu</a>
                        </li> 
                <li>
                            <a href="#">About us</a>
                        </li> 
                <li>
                            <a href="#">Contact us</a>
                        </li>
                <li>
                </li>
            </ul> 
        </nav> 
        <!-- a nested Fore element is used and loaded from login.html. The containing fx-fore element from that page
        is extracted and replaces the original element in the DOM. The login page contains the complete logic and
        UI for a form-based login into eXist-db. -->
        <fx-fore id="login" src="login.html"/>

        <!-- template expressions can occur on nearly any attribute but are most valuable to switch CSS classes.
        They are evaluated as XPath 3.1 expressions - here a conditional is used to set the CSS class to either 'loggedIn'
        or 'hidden'.
        When a user is not logged in the class will be 'hidden' and the whole section is invisible to the user -->
        <section class="{if(string-length(instance()/@user) != 0) then 'loggedIn' else 'hidden'}">
            <div class="info">
                <!-- template expressions can used builtin and custom functions and access pathes in your
                instance data with the help of the 'instance()' function. Without args it returns the first
                in document order which is always the default.-->
                <p>New version of <strong>eNahar ICal manager</strong> using (Fore instead of Betterforms)</p>
            </div>

            <div class="gridh">
            
              <div class="wrapit">
                <fx-control id="proflist" ref="instance('selected')/profession" update-event="change">
                    <label>Service</label>
                    <select class="widget" selection="open">
                        <option value="arzt">Ärzte</option>
                        <option value="psych">Psychologie</option>
                        <option value="ergo">Ergotherapie</option>
                        <option value="logo">Logopädie</option>
                        <option value="physio">Physiotherapie</option>
                        <option value="eeg">EEG</option>
                        <option value="ep-nlg">EP-NLG</option>
                    </select>
                </fx-control>
              </div>
              <div class="wrapit">
                <fx-control id="provider" ref="instance('selected')/selected" update-event="change">
 
                    <label>Erbringer</label>
                    <select class="widget" ref="instance('i-ical-list')//cal" selection="open">
                        <template>
                            <option value="{./id/@value/string()}">{./owner/display/@value/string()}</option>
                        </template>
                    </select>
                    <fx-send event="value-changed" submission="s-read-ical"/>
                    <!-- refresh itself if proflist changes -->
                    <fx-refresh event="value-changed" target="proflist" self="self"/>
                </fx-control>
              </div>
              <div class="wrapit">
                <fx-control ref="instance('selected')/show-all-agendas" update-event="input" value-prop="checked">
                      <div style="float:left;margin-right:20px;">
                        <label class="" for="check1">All iCals?</label>
                        <input id="check1" class="widget" type="checkbox"/>
                      </div>
                        <fx-send event="value-changed" submission="s-load-names"/>
                </fx-control>
              </div>
              <div class="wrapit">
                <fx-trigger ref="instance('i-control')/save-trigger">
                    <button>Save ical</button>
                    <fx-action>
                        <fx-send submission="s-save"/>
                    </fx-action>
                </fx-trigger>
              </div>
            </div>
        </section>
        <section class="{if(string-length(instance()/@user) != 0) then 'loggedIn' else 'hidden'}">
<!--
        <fx-repeat id="schedule" ref="instance('i-cals')/schedule"  style="grid-template-columns: repeat({count(instance('i-cals')/schedule)},1fr);">
            <template>
                <div class="header">
                    <fx-output ref="./global/display/@value"></fx-output>
                </div>
                <div class="board">
                    <fx-repeat id="agenda" ref="agenda">
                        <template>
                            <div class="card">
                                <fx-output ref="period/start/@value"></fx-output>
                                <fx-repeat id="event" class="event" ref="event">
                                    <template>
                                        <div class="act-text">
                                            <fx-control ref="./name/@value"></fx-control>
                                        </div>
                                    </template>
                                </fx-repeat>
                            </div>
                        </template>
                    </fx-repeat>
                </div>
            </template>
        </fx-repeat>
-->
        <details>
            <summary>Globale Infos</summary>
            <fx-group class="wrapit" ref="instance('i-cals')">
            <h3>Globals</h3>
            <table>
              <tr>
                <td>
                                        <strong>LastModifiedBy</strong>
                                    </td>
                <td>
                                        <fx-output ref="./lastModifiedBy/display/@value"/>
                </td>
              </tr>
            <tr>
                <td>
                                        <strong>LastModified</strong>
                                    </td>
                <td>
                                        <fx-output ref="./lastModified/@value"/>
                </td>
            </tr>            
            <tr>
                <td>
                                        <strong>Owner</strong>
                                    </td>
                <td>
                                        <fx-output ref="./owner/display/@value"/>
                </td>
            </tr>
            <tr>
                <td>
                                        <strong>Summary</strong>
                                    </td>
                <td>
                                        <fx-output ref="./summary/@value"/>
                </td>
            </tr>
            <tr>
                <td>
                                        <strong>Decription</strong>
                                    </td>
                <td>
                                        <fx-output ref="./description/@value"/>
                </td>
            </tr>
            <tr>
                <td>
                                        <strong>Active</strong>
                                    </td>
                <td>
                                        <fx-output ref="./active/@value"/>
                </td>
            </tr>
            <tr>
                <td>
                                        <strong>CUType</strong>
                </td>
                <td>
                                        <fx-output ref="./cutype/text/@value"/>
                </td>
            </tr>
            <tr>
                <td>
                                        <strong>CalType</strong>
                                    </td>
                <td>
                                        <fx-output ref="./caltype/text/@value"/>
                                    </td>
            </tr>  
            <tr>
                <td>
                                        <strong>Location</strong>
                                    </td>
                <td>
                                        <fx-output ref="./location/display/@value"/>
                                    </td>
            </tr> 
            <tr>
                <td>
                                        <strong>TimeZone</strong>
                                    </td>
                <td>
                                        <fx-output ref="./timezone/@value"/>
                                    </td>
            </tr>
            </table>
            </fx-group>
        </details>
        <div class="grid">
            <fx-group ref="instance('i-cals')" class="wrapit">
                <h3>Schedules</h3>
                <fx-group ref="./schedule[count(.)=0]">
                    <span>no schedule</span>
                </fx-group>
                <fx-repeat id="r-sched" ref="./schedule">
                    <template>
                    <fx-action event="item-changed">
                        <fx-message>schedule: item-changed</fx-message>
                    </fx-action>
                        <div>
                            <fx-output value="substring(./global/type/@value,1,1)"/>
                            <fx-output ref="./global/display/@value"/>
                            <fx-trigger class="iconbtn del">
                                <button>X</button>
                                <fx-action>
                                    <fx-delete ref="."/>
                                    <fx-setvalue ref="instance('i-control')/dirty" value="'true'"/>
                                </fx-action>
                            </fx-trigger>
                        </div>
                        <fx-refresh event="value-changed" target="schedlist" self="self"/>
                    </template>
                </fx-repeat>
                <fx-group id="ssub" ref="./schedule[index('r-sched')]">
                <table>
                    <tr>
                        <td>
                            <div>
                                <span>
                                                    <strong>{./global/display/@value}</strong>
                                                </span>
                                <div>
                                <fx-control ref="instance('selected')/schedule-type" update-event="change" selection="open">
                                    <select class="widget">
                                        <option value="service">Service</option>
                                        <option value="worktime">RegAZ</option>
                                        <option value="meeting">Meeting</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                    <fx-action event="value-changed">
                                        <fx-message>Schedule type changed</fx-message>
                                        <fx-send submission="s-schedule-names"/>
                                    </fx-action>
                                </fx-control>
                                <fx-control id="schedlist" ref="instance('selected')/schedule-ref" update-event="change">
                                    <select ref="instance('i-schedule-list')//Schedule" class="widget" selection="open">
                                        <template>
                                            <option value="{./id/@value}">{./name/@value}</option>
                                        </template>
                                    </select>
                                    <fx-action event="value-changed">
                                        <fx-message>Schedule selected</fx-message>
                                        <fx-setvalue ref="instance('i-cals')//cal/schedule[index('r-sched')]/global/reference/@value" value="concat('enahar/schedules/',instance('i-schedule-list')//Schedule[id/@value=instance('selected')/schedule-ref]/name/@value)"/>
                                        <fx-setvalue ref="instance('i-cals')//cal/schedule[index('r-sched')]/global/display/@value" value="instance('i-schedule-list')//Schedule[id/@value=instance('selected')/schedule-ref]/name/@value"/>
                                    </fx-action>
                                </fx-control>
                                </div>
                            </div>
                        </td>
                        <td>
                            <fx-trigger>
                                <button>Neu</button>
                                <fx-action>
                                    <fx-insert position="before" at="1" ref="." context="instance('i-cals')" origin="instance('i-calInfos')/bricks/schedule"/>
                                    </fx-action>
                            </fx-trigger>
                        </td>
                    </tr>
                    <tr>
                        <td>Spezialambulanz</td>
                        <td>
                            <fx-control id="special" ref=".[index('r-sched')]/global/isSpecial/@value">
                                <input id="special-check" class="widget" type="checkbox"/>
                            </fx-control>
                        </td>
                    </tr> 
                    <tr>
                        <td>Fallführung</td>
                        <td>
                            <fx-control id="ff" ref=".[index('r-sched')]/global/ff/@value">
                                <input id="ff-check" class="widget" type="checkbox"/>
                            </fx-control>
                        </td>
                    </tr>
                </table>
                </fx-group>
            </fx-group>

            <fx-group ref="instance('i-cals')" class="wrapit">
                <h3>Agendas</h3>
                <fx-repeat id="r-agenda" ref="./schedule[index('r-sched')]/agenda">
                    <template>
                        <fx-action event="item-changed">
                            <fx-message>agenda: item-changed</fx-message>
                        </fx-action>
                        <div style="{if (exists(./period/end/@value) and ./period/end/@value!='' and ./period/end/@value &lt; instance('default')/today) then 'background-color: rgba(180, 180, 70, 0.8); transform:skewX(-20deg)' else ''}">
                            <fx-output value="substring(./period/start/@value,1,10)"/>
                            <fx-output value="substring(./period/end/@value,1,10)"/>
                            <fx-trigger class="iconbtn del">
                                <button>X</button>
                                <fx-action>
                                    <fx-delete ref="."/>
                                    <fx-setvalue ref="instance('i-control')/dirty" value="'true'"/>
                                </fx-action>
                            </fx-trigger>
                        </div>
                    </template>
                </fx-repeat>
                <table>
                        <tr>
                            <td>
                                <fx-trigger>
                                    <button>Neu</button>
                                    <fx-action>
                                        <fx-insert position="after" at="index('r-agenda')" ref="instance('i-cals')/schedule[index('r-sched')]/agenda" context="instance('i-cals')/schedule[index('r-sched')]" origin="instance('i-calInfos')/bricks/agenda"/>
                                    </fx-action>
                                </fx-trigger>
                            </td>
                            <td>
                                <fx-trigger ref="instance('i-control')/has-agenda">
                                    <button>Clone</button>
                                    <fx-action>
                                        <fx-insert position="after" at="index('r-agenda')" ref="[./owner/reference/@value=instance('selected')/selected]/schedule[index('r-sched')]/agenda" origin="[./owner/reference/@value=instance('selected')/selected]/schedule[index('r-sched')]/agenda[index('r-agenda')]"/>
                                </fx-action>
                            </fx-trigger>
                        </td>
                    </tr>
                </table>
            </fx-group>
            <fx-group ref="instance('i-cals')" class="wrapit">
                <h3>Events</h3>
                <fx-repeat id="r-event" ref="./schedule[index('r-sched')]/agenda[index('r-agenda')]/event">
                    <template>
                            <fx-action event="item-changed">
                                <fx-message>event: item-changed</fx-message>
                            </fx-action>
                        <div>
                            <fx-output value="./name/@value"/>
                            <fx-trigger class="iconbtn del">
                                <button>X</button>
                                <fx-action>
                                    <fx-delete ref="."/>
                                    <fx-setvalue ref="instance('i-control')/dirty" value="'true'"/>
                                </fx-action>
                            </fx-trigger>
                        </div>
                    </template>
                </fx-repeat>

                <table>
                        <tr>
                            <td>
                                <fx-trigger>
                                    <button>Neu</button>
                                    <fx-action>
                                        <fx-insert position="after" at="index('r-event')" ref="instance('i-cals')/schedule[index('r-sched')]/agenda[index('r-agenda')]/event" context="instance('i-cals')/schedule[index('r-sched')]/agenda[index('r-agenda')]" origin="instance('i-calInfos')/bricks/event"/>
                                    </fx-action>
                                </fx-trigger>
                            </td>
                        </tr>
                </table>
            </fx-group>

            <fx-group class="wrapit">
                <fx-control id="fevent" ref="instance('i-cals')/schedule[index('r-sched')]/agenda[index('r-agenda')]/event[index('r-event')]" src="event.html" initial=".">
                </fx-control>
            </fx-group>

        </div>
        </section>
    </fx-fore>
</div>
</body>
</html>