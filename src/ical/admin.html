<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes" name="viewport"/>
    <title>iCal</title>
    <link rel="shortcut icon" type="image/png" href="../resources/images/icon.png" sizes="16x16"/>
    <link rel="stylesheet" href="../resources/css/theme.css" media="screen"/>
    <link rel="stylesheet" href="../resources/css/fore.css" media="screen"/>
    <link rel="stylesheet" href="../resources/css/edep-theme.css"/>
    <link rel="stylesheet" href="../resources/css/edep-theme2.css"/>
    <script type="module">
        import '@polymer/iron-iconset-svg/iron-iconset-svg.js';
        import '@polymer/iron-icon/iron-icon.js';
    </script>
    <script type="module" src="../resources/scripts/jinn-codemirror-bundle.js"/>
<!--    <script type="module" src="http://localhost:8090/index.js"></script>-->
    <script type="module" src="../resources/scripts/fore-dev.js"/>
    <style>
        .iconbtn{
            grid-area: icon;
        }
        .iconbtn{
            position: relative;
            right: 0rem;
        }
        .iconbtn button:hover{
            background: red;
            color: white;
        }
        .del{
            float: right;
        }
        .iconbtn button{
            border-radius: 50%;
            border:none;
            color:black;
            background: white;
        }

ul{
 background-color: #ff4081;
 margin: 0px;
 padding: 0px;
 overflow: hidden;
 list-style-type: none;
 } 
li a:hover:not(.active){
 background-color: #6a0080;
 }
 li{
 float: left;
 }
 li a{
 color: #ffffff;
 display: block;
 text-align: center;
 padding: 15px 15px;
 text-decoration: none;
 }
 .active{
 background-color: #78002e;
 }
    </style>
</head>
<body>
<div class="wrapper">
    <!-- for accessability adding a 'role' and 'title' to make it a landmark -->
    <fx-fore xmlns:fhir="http://hl7.org/fhir" id="ical" title="ical app" role="form">
        <!-- When Fore is ready, it receives the 'ready' event and we can savely interact with the UI, setting
        the focus to the control with id 'task'. -->
        <fx-setfocus control="provider" event="ready"/>

        <!-- listening on document for an 'logged-in' event, storing the username and loading initial data.  -->
        <fx-action event="model-construct-done" target="#document">
            <fx-setvalue ref="instance()/@user" value="event('user')"/>
            <fx-update/>
            <fx-send submission="s-ical-names"/>
        </fx-action>

        <!-- listening on document for an 'logged-out' event, output a message and reset username -->
        <fx-action event="logged-out" target="#document">
            <fx-message>logged out {event('user')}</fx-message>
            <fx-setvalue ref="instance()/@user"/>
            <fx-update/>
            <fx-refresh/>
        </fx-action>

        <fx-model>

            <fx-instance id="default">
                <data user="admin">
                    <cutype>individual</cutype>
                    <cutypes>
                        <option value="individual">Individual</option>
                        <option value="group">Group</option>
                        <option value="template">Template</option>
                    </cutypes>
                    <selected/>
                    <profession>arzt</profession>
                    <professions>
                        <option value="arzt">Ärzte</option>
                        <option value="psych">Psychologie</option>
                        <option value="ergo">Ergotherapie</option>
                        <option value="logo">Logopädie</option>
                        <option value="physio">Physiotherapie</option>
                        <option value="eeg">EEG</option>
                        <option value="ep-nlg">EP-NLG</option>
                    </professions>
                    <schedule-type>service</schedule-type>
                    <schedule-types>
                        <option value="service">Service</option>
                        <option value="worktime">RegAZ</option>
                        <option value="meeting">Meeting</option>
                        <option value="admin">Admin</option>
                    </schedule-types>
                    <schedule-ref/>
                    <show-all-agendas>false</show-all-agendas>
                    <show-all-icals>false</show-all-icals>
                    <isspecial>false</isspecial>
                    <today>2025-07-28</today>
                    <is-old>0</is-old>
                </data>
            </fx-instance>
            
            <fx-instance id="i-providers">
                <data>
                </data>
            </fx-instance>
            
            <fx-instance id="i-schedules">
                <data>
                </data>
            </fx-instance>            

            <fx-instance id="i-cal">
                <data>
                </data>
            </fx-instance>

            <fx-instance id="i-services">
                <data>
                </data>
            </fx-instance>

            <fx-instance id="i-servicetypes">
                <data>
                </data>
            </fx-instance>

            <fx-instance id="i-specialties">
                <data>
                    <code value="arzt" label="Arzt"/>
                    <code value="psych" label="Psych"/>
                    <code value="team" label="Team"/>
                </data>
            </fx-instance>

            <fx-instance id="i-orgs">
                <data>
                    <Organization xmlns="http://hl7.org/fhir">
                        <id value="ukk-kikl"/>
                        <name value="UKK KiKl"/>
                    </Organization>
                </data>
            </fx-instance>
          <!--
          <fx-bind ref=".//byDay/@value" constraint="local:days-validjs(.,/../../freq/@value)">
              <fx-alert>
                <h4>byDay invalid</h4>
                <p>Erlaubt ist eine Komma separierte Liste von
                    Werktagen, gfls. mit Prefix für die Woche (Mo,5:Do)</p>
              </fx-alert>
          </fx-bind>
          <fx-bind ref=".//byWeekNo/@value" constraint="local:weeks-validjs(.,./../../freq/@value)">
              <fx-alert>
                <h4>byWeekNo invalid</h4>
                <p>Erlaubt ist alternativ:
                    <ul>
                        <li>every, even, odd für die Kalenderwochen</li>
                        <li>eine Komma separierte numerische Liste von KW (mit 'wöchentlich')</li>
                    </ul>
                </p>
              </fx-alert>
          </fx-bind>
          -->

            <fx-bind ref="instance('default')">
                <!--
                <fx-bind ref="show-all-agendas" type="xs:boolean"/>
                <fx-bind ref="show-all-cals" type="xs:boolean"/>
                -->
            </fx-bind>

            <!-- the infos instance contains some nodes being used at runtime and is the structure is loaded from
            an external xml file. -->
            <fx-instance id="i-ical-infos" src="ical-infos.xml"/>

            
            <!-- submissions send http requests. This one loads all ical owners with a GET request and
            replace our ical-list instance with the response data. -->
            <fx-submission id="s-ical-names" url="http://localhost:8080/exist/apps/nonfhir/ICal?_elements=id,actor,name&amp;cutype={instance('default')/cutype}&amp;active=true" method="get" replace="instance" instance="i-providers" validate="false">
                <fx-header name="Accept">application/xml</fx-header>
                <fx-message event="submit-error">could not load ical names</fx-message>
                <fx-message event="submit-done">ical names loaded</fx-message>
            </fx-submission>
             <fx-submission id="s-schedule-names" url="http://localhost:8080/exist/apps/nonfhir/ICal?_elements=id,type,name,ff&amp;active=true&amp;type={instance('default')/schedule-type}" method="get" replace="instance" instance="i-schedules" mediatype="application/fhir+xml">
                <fx-header name="Accept">application/xml</fx-header>
                <fx-message event="submit-error">could not load schedules</fx-message>
                <fx-message event="submit-done">schedules loaded</fx-message>
            </fx-submission>
            
            <!-- this one loads ical of selected owner with a GET request and replace our i-cal instance with the response data. -->
            <fx-submission id="s-read-ical" url="http://localhost:8080/exist/apps/nonfhir/ICal/{instance('default')/selected}" method="get" replace="instance" instance="i-cal" mediatype="application/fhir+xml">
                <fx-header name="Accept">application/xml</fx-header>
                <fx-message event="submit-error">could not load ical</fx-message>
                <fx-message event="submit-done">ical loaded</fx-message>
            </fx-submission>

            <!-- this submission saves the current ical with a PUT request to the ICal API. -->
            <fx-submission id="s-save" url="http://localhost:8080/exist/apps/nonfhir/ICal/{instance('default')/selected}" method="put" replace="none" nonrelevant="keep" mediatype="application/fhir+xml">
                <fx-header name="Accept">application/xml</fx-header>
                <fx-message event="submit-error">ical for {instance('i-cal')/owner/display/@value} could not stored</fx-message>
                <fx-message event="submit-done">ical for {instance('i-cal')/owner/display/@value} stored</fx-message>
            </fx-submission>
            
            <fx-instance id="i-control">
                <data>
                    <dirty>false</dirty>
                    <save-trigger/>
<!--
                    <has-schedule></has-schedule>
                    <has-agenda></has-agenda>
                    <has-event></has-event>
                    <no-schedule></no-schedule>
                    <no-agenda></no-agenda>
                    <no-event></no-event>
                    <has-rdate></has-rdate>
-->
                </data>
            </fx-instance>

            <fx-bind ref="instance('i-control')">

                <fx-bind ref="./show-all-agendas" type="xs:boolean"/>
                
                <fx-bind ref="./save-trigger" relevant="boolean-from-string(instance('i-control')/dirty)"/>
<!--
                <fx-bind ref="./has-schedule" relevant="exists(instance('i-cal')//*:schedule)"/>
                <fx-bind ref="./has-agenda" relevant="exists(instance('i-cal')//*:schedule[index('r-sched')]/agenda)"/>
                <fx-bind ref="./has-event"  relevant="exists(instance('i-cal')//*:schedule[index('r-sched')]/agenda[index('r-agenda')]/event)"/>
                <fx-bind ref="./has-rdate"  relevant="exists(instance('i-cal')//*:schedule[index('r-sched')]/agenda[index('r-agenda')]/event[index('r-event')]/rdate/date/@value)"/>
-->
            </fx-bind>
            
            <fx-instance id="helper">
                <data>
                    <period>
                        <start value=""/>
                        <end value=""/>
                    </period>
                </data>
            </fx-instance>
            
            <fx-function signature="local:days-validjs($byday as xs:string, $freq as xs:string) as xs:boolean" type="text/javascript">
              const reday = /^$|^([1-5]:)?(Mo|Di|Mi|Do|Fr)(,([1-5]:)?(Mo|Di|Mi|Do|Fr))*$/;         
              var s = $byday, f = $freq;
              return reday.test(s); 
            </fx-function>
            <fx-function signature="local:weeks-validjs($byweek as xs:string, $freq as xs:string) as xs:boolean" type="text/javascript">
              const rewk = /^(every|even|odd|\d{1,2}(,\d{1,2})*)$/;
              var s = $byweek, f = $freq, r = false;
              if (f=="weekly") {
                r = rekw.test(s);
              }
              return r;
            </fx-function>
            
        </fx-model>
        <nav> 
            <ul> 
                <li>
                    <a class="active" href="#">eNahar Admin</a>
                </li> 
                <li>
                    <a href="#">Menu</a>
                </li> 
                <li>
                    <a href="#">About us</a>
                </li> 
                <li>
                    <a href="#">Contact us</a>
                </li>
                <li>
                </li>
            </ul> 
        </nav> 
        <!-- a nested Fore element is used and loaded from login.html. The containing fx-fore element from that page
        is extracted and replaces the original element in the DOM. The login page contains the complete logic and
        UI for a form-based login into eXist-db.
        <fx-fore id="login" src="login.html"></fx-fore>
-->

        <!-- template expressions can occur on nearly any attribute but are most valuable to switch CSS classes.
        They are evaluated as XPath 3.1 expressions - here a conditional is used to set the CSS class to either 'loggedIn'
        or 'hidden'.
        When a user is not logged in the class will be 'hidden' and the whole section is invisible to the user -->
        <section class="{if(string-length(instance()/@user) != 0) then 'loggedIn' else 'hidden'}">
            <div class="info">
                <!-- template expressions can used builtin and custom functions and access pathes in your
                instance data with the help of the 'instance()' function. Without args it returns the first
                in document order which is always the default.-->
                <p>eNahar <strong>ICal manager</strong>
                        </p>
            </div>

            <fieldset>
                <legend>Search</legend>
                <fx-control id="cutype" ref="./cutype" update-event="change">
                    <label>Service</label>
                    <select ref="instance('default')/cutypes/option" class="widget">
                        <template>
                            <option value="{@value}">{.}</option>
                        </template>
                    </select>
                    <fx-send event="value-changed" submission="s-ical-names"/>
                </fx-control>
                <fx-group ref="./cutype[.='individual']">
                <fx-control id="proflist" ref="instance('default')/profession" update-event="change">
                    <label>Service</label>
                    <select ref="instance('default')/professions/option" class="widget" selection="open">
                        <template>
                            <option value="{@value}">{.}</option>
                        </template>
                    </select>
                    <fx-send event="value-changed" submission="s-ical-names"/>
                </fx-control>
                </fx-group>
                <fx-control id="provider" ref="instance('default')/selected" update-event="change">
                    <label>iCal Name</label>
                    <select ref="instance('i-providers')//*:ICal" class="widget" selection="open">
                        <template>
                            <option value="{./*:id/@value}">{./fhir:name/@value}</option>
                        </template>
                    </select>
                    <fx-send event="value-changed" submission="s-read-ical"/>
                    <!-- refresh itself if cutype or proflist changes -->
                    <fx-refresh event="value-changed" target="cutype" self="self"/>
                    <fx-refresh event="value-changed" target="proflist" self="self"/>
                </fx-control>
                <fx-control ref="./show-all-icals" update-event="input" value-prop="checked">
                        <label class="" for="check1">All iCals?</label>
                        <input id="check1" class="widget" type="checkbox"/>
                        <fx-send event="value-changed" submission="s-ical-names"/>
                </fx-control>
                <fx-trigger>
                    <button>New</button>
                    <fx-action>
                        <fx-insert ref="./fhir:ICal" context="instance('i-cal')" origin="instance('i-ical-infos')//*:ICal[fhir:cutype//fhir:code/@value='empty']"/>
                        <fx-show dialog="d-new-ical"/>
                    </fx-action>
                </fx-trigger>
                <fx-trigger ref="instance('i-control')/save-trigger">
                    <button>Save</button>
                    <fx-action>
                        <fx-send submission="s-save"/>
                    </fx-action>
                </fx-trigger>
                <fx-dialog id="d-new-ical">
                    <fx-setfocus control="ical-cutype" event="dialog-shown" delay="500"/>
                    <div class="dialog-content">
                    <header>New ICal</header>
                    <fx-control id="ical-id" ref="instance('i-cal')//fhir:identifier/fhir:value/@value">
                        <label>ID</label>
                    </fx-control>
                    <fx-control id="ical-cutype" ref="instance('i-cal')//fhir:cutype/fhir:coding/fhir:code/@value" update-event="change">
                        <label>Type</label>
                        <select class="widget" name="cutype" ref="instance('default')/cutypes/option">
                            <template>
                                <option value="{./@value}">{.}</option>
                            </template>
                            <fx-action event="value-changed">
                            <!--
                            <fx-setvalue ...
                            <fx-insert actor
                            -->
                            </fx-action>
                        </select>
                    </fx-control>
                    <fx-control id="ical-caltype" ref="instance('i-cal')//fhir:caltype/fhir:coding/fhir:code/@value" update-event="change">
                        <label>Type</label>
                        <select class="widget" name="caltype" ref="instance('default')/cutypes/option">
                            <template>
                                <option value="{./@value}">{.}</option>
                            </template>
                            <fx-action event="value-changed">
                            <!--
                            <fx-setvalue ...
                            -->
                            </fx-action>
                        </select>
                    </fx-control>
                    <fx-control id="ical-caltype" ref="instance('i-cal')/fhir:ICal/fhir:actor/fhir:reference/@value" update-event="change">
                        <label>Owner</label>
                        <select class="widget" name="user" ref="instance('default')/cutypes/option">
                            <template>
                                <option value="{./@value}">{.}</option>
                            </template>
                            <fx-action event="value-changed">
                            <!--
                            <fx-setvalue ...
                            -->
                            </fx-action>
                        </select>
                    </fx-control>
                <fx-trigger class="action">
                    <button>Schließen</button>
                    <fx-hide dialog="d-new-ical"/>
                    
                    <fx-message>New Ical initialzed</fx-message>              
                </fx-trigger>
            </div>
            </fx-dialog>
             </fieldset>
        </section>
        <section class="{if(string-length(instance()/@user) != 0) then 'loggedIn' else 'hidden'}">
        <details>
            <summary>
                <strong>{if (instance('i-cal')[./fhir:id/@value]) then 'Global Infos' else 'No iCal selected'}</strong>
            </summary>
            <fx-group class="wrapit" ref="instance('i-cal')">
            <fx-action event="value-changed">
                <fx-message>value-changed</fx-message>
                <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
            </fx-action>
            <details>
                <summary>Info only</summary>
                <fieldset>
                <legend>LastUpdated</legend>
                <fx-output ref="./fhir:meta/fhir:extension/fhir:valueReference/fhir:display/@value">
                    <label slot="label">Erbringer</label>
                </fx-output>
                <fx-output ref="./fhir:meta/fhir:lastUpdated/@value">
                    <label slot="label">Date</label>
                </fx-output>
                </fieldset>
                <fieldset>
                <legend>Invariants</legend>
                <fx-output ref="./fhir:cutype//fhir:code/@value">
                    <label slot="label">CUType</label>
                </fx-output>
                <fx-output ref="./fhir:caltype//fhir:code/@value">
                    <label slot="label">CalType</label>
                </fx-output>
                <fx-output ref="./fhir:actor/fhir:display/@value">
                    <label slot="label">Owner</label>
                </fx-output>
                </fieldset>
            </details>
            <fieldset>
                <fx-control ref="./fhir:active/@value" update-event="input" value-prop="checked">
                    <label>active?</label>
                    <input id="active" type="checkbox"/>
                </fx-control>
                <fieldset>
                <legend>
                                        <label>ServiceCategory</label>
                    <fx-trigger class="add" title="ServiceCategory hinzufügen">
                        <iron-icon class="add-icon-outline" title="ServiceCategory hinzufügen"/>
                        <!--
                        <fx-insert/>
                        <fx-refresh/>
                        -->
                    </fx-trigger>
                </legend>
                <fx-repeat ref="./fhir:serviceCategory">
                    <template>
                    <div>
                        <fx-control ref=".//fhir:code/@value">
                    <select ref="instance('i-services')//*:ICal" class="widget" selection="open">
                        <template>
                            <option value="{./*:id/@value}">{./fhir:actor/fhir:display/@value}</option>
                        </template>
                    </select>
                        </fx-control>
                    </div>
                    <fx-trigger class="add" title="ServiceCategory löschen">
                        <iron-icon class="remove-icon-outline" title="ServiceCategory löschen"/>
                        <!--
                        <fx-delete>.</fx-delete>
                        <fx-refresh/>
                        -->
                    </fx-trigger>
                    </template>
                </fx-repeat>
                </fieldset>
                <fieldset>
                <legend>
                    <label>ServiceType</label>
                 <fx-trigger class="add" title="ServiceCategory hinzufügen">
                        <iron-icon icon="add-icon-outline" title="ServiceType hinzufügen"/>
                        <!--
                        <fx-insert/>
                        <fx-refresh/>
                        -->
                    </fx-trigger>
                </legend>
                <fx-repeat ref="./fhir:serviceType">
                    <template>
                    <div>
                        <fx-control ref=".//fhir:display/@value">
                            <select ref="instance('i-servicetypes')//*:ICal" class="widget" selection="open">
                                <template>
                                    <option value="{./*:id/@value}">{./fhir:actor/fhir:display/@value}</option>
                                </template>
                            </select>
                        </fx-control>
                    <fx-trigger class="add" title="ServiceCategory löschen">
                        <iron-icon icon="remove-icon-outline" title="ServiceType löschen"/>
                        <!--
                        <fx-delete>.</fx-delete>
                        <fx-refresh/>
                        -->
                    </fx-trigger>
                    </div>
                    </template>
                </fx-repeat>
                </fieldset>
                <fieldset>
                    <legend>
                                        <label>Specialty</label>
                 <fx-trigger class="add" title="ServiceCategory hinzufügen">
                        <iron-icon icon="add-icon-outline" title="Specialty hinzufügen"/>
                        <!--
                        <fx-insert/>
                        <fx-refresh/>
                        -->
                    </fx-trigger>
                </legend>
                <fx-repeat ref="./fhir:specialty">
                    <template>
                    <div>
                        <fx-control ref=".//fhir:code/@value">
                            <select ref="instance('i-specialties')//*:code" class="widget" selection="open">
                                <template>
                                    <option value="{./@value}">{./@label}</option>
                                </template>
                            </select>
                        </fx-control>
                    </div>
                    <fx-trigger class="add" title="ServiceCategory löschen">
                        <iron-icon icon="remove-icon-outline" title="Specialty löschen"/>
                        <!--
                        <fx-delete>.</fx-delete>
                        <fx-refresh/>
                        -->
                    </fx-trigger>
                    </template>
                </fx-repeat>
                </fieldset>
                <fx-control ref="./fhir:name/@value">
                    <label>Name</label>
                 <fx-trigger class="add" title="Organization hinzufügen">
                        <iron-icon icon="add-icon-outline" title="Organization hinzufügen"/>
                        <!--
                        <fx-insert/>
                        <fx-refresh/>
                        -->
                    </fx-trigger>
                </fx-control>
                <fieldset>
                <legend>
                                        <label>Organization</label>
                </legend>
                <fx-repeat ref="./fhir:organization">
                    <template>
                    <div>
                        <fx-control ref="./fhir:display/@value">
                            <select ref="instance('i-orgs')//fhir:Organization" class="widget" selection="open">
                                <template>
                                    <option value="Organization/{./*:id/@value}">{./fhir:name/@value}</option>
                                </template>
                            </select>
                        </fx-control>
                    </div>
                    <fx-trigger class="add" title="Organization löschen">
                        <iron-icon icon="remove-icon-outline" title="Organization löschen"/>
                        <!--
                        <fx-delete>.</fx-delete>
                        <fx-refresh/>
                        -->
                    </fx-trigger>
                    </template>
                </fx-repeat>
                </fieldset>
                <fx-control ref="./fhir:comment/@value">
                    <label>Comment</label>
                </fx-control>
            </fieldset>
            </fx-group>
        </details>
        <details id="sched-list">
          <summary>
            <strong>{if (instance('i-cal')[./fhir:schedule]) then '' else 'No '}Schedules</strong>
          </summary>
          <fieldset>
          <legend>
                                <label>Schedules</label>
            <fx-trigger ref="instance('i-cal')[./fhir:schedule]">
                    <button>Neu</button>                                                                                                 
                    <fx-action>         
                    <!-- insert correct template for schedule type
                       <fx-insert position="before" at="1" ref="./schedule" context="instance('i-cal')" origin="instance('i-ical-infos')/bricks/schedule"/>
                    -->
                       <fx-show dialog="d-new-schedule"/>
                    </fx-action>
            </fx-trigger>
            <fx-dialog id="d-new-schedule">
                <fx-setfocus control="schedule-type" event="dialog-shown" delay="500"/>
                <div class="dialog-content">
                <header>Schedule Type</header>
                    <fx-control id="schedule-type" ref="instance('i-cal')/fhir:schedule/fhir:type/@value" update-event="change">
                        <label>Type</label>
                        <select class="widget" name="user" ref="instance('default')/schedule-types/option">
                            <template>
                                <option value="{./@value}">{.}</option>
                            </template>
                        </select>
                    </fx-control>
                <fx-trigger class="action">
                    <button>Schließen</button>
                    <fx-hide dialog="d-new-schedule"/>
                    
                    <fx-message>Schedule type changed</fx-message>              
                    <fx-send submission="s-schedule-names"/>                    
                </fx-trigger>
            </div>
            </fx-dialog>
           </legend>
        <fx-repeat id="r-sched" ref="instance('i-cal')/fhir:schedule">
<!--
            <fx-action event="item-changed" target="r-sched">
                <fx-message>schedule: item-changed; 1 index: {event('index')}</fx-message>
            </fx-action>
-->
            <template>
                <div>
            <fx-action event="value-changed">
                <fx-message>s: value-changed</fx-message>
                <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
            </fx-action>
                    <fieldset>
                    <legend>{./fhir:basedOn/fhir:display/@value}</legend>
<!--
                    <fx-control id="all-scheds" ref="./schedule-ref" update-event="change">
                        <label>Select Schedule</label>
                        <select ref="instance('i-schedules')//fhir:ICal" class="widget" selection="open"> 
                            <template>                                                                       
                                <option value="{./*:id/@value}">{./fhir:name/@value}</option>                       
                            </template>                                                                      
                        </select>                                                       
                        <fx-action event="value-changed">                               
                            <fx-message>Schedule selected</fx-message>                  
                            <fx-setvalue ref="instance('i-cal')/schedule[index('r-sched')]/global/reference/@value">{concat('enahar/schedules/',instance('i-schedules')//Schedule[id/@value=instance('default')/schedule-ref]/name/@value)}</fx-setvalue>
                            <fx-setvalue ref="instance('i-cal')/schedule[index('r-sched')]/global/display/@value">{instance('i-schedules')//Schedule[id/@value=instance('default')/schedule-ref]/name/@value}</fx-setvalue>
                            <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                        </fx-action>
                    </fx-control>     
-->
                    <fx-output ref="./fhir:realm/fhir:display/@value"/>
                    <fx-group> <!-- if type=service -->
                        <fx-control id="special" ref="./fhir:isSpecial/@value">
                            <label>Spezialambulanz</label>
                            <input id="special-check" class="widget" type="checkbox"/>  
                            <fx-action event="value-changed">
                                <fx-message>s1: value-changed</fx-message>
                                <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                            </fx-action>
                        </fx-control>
                        <fx-control id="ff" ref="./fhir:ff/@value">
                            <label>Fallführung</label>
                            <input id="ff-check" class="widget" type="checkbox"/>
                            <fx-action event="value-changed">
                                <fx-message>s2: value-changed</fx-message>
                                <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                            </fx-action>
                        </fx-control>
                    </fx-group>
                        <div>
                		        <fx-control ref="./fhir:period/fhir:start/@value" update-event="input">
                                    <label for="a-start">Von</label>
            			            <input id="a-start" class="widget" type="date"/>
                	    		</fx-control>
                				<fx-trigger ref="./fhir:period[not(./fhir:start)]">
                                    <button>Von?</button>
                                    <fx-insert ref="./fhir:period/fhir:start" context="./fhir:period" origin="instance('helper')/fhir:period/fhir:start"/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-trigger>
            			        <fx-trigger ref="./fhir:period/fhir:start">
                                    <button>x</button>
                                    <fx-delete ref="./fhir:period/fhir:start"/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-trigger>
                            </div>
                            <div>
            		            <fx-control ref="./fhir:period/fhir:end/@value" update-event="input">
                                    <label for="a-end">Bis</label>
                		    	    <input id="a-end" class="widget" type="date"/>
                    			</fx-control>
            				    <fx-trigger ref="./fhir:period[not(./fhir:end)]">
                                    <button>Bis?</button>
                                    <fx-insert ref="./fhir:period/fhir:end" context="./fhir:period" origin="instance('helper')/fhir:period/fhir:end"/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-trigger>
            			    	<fx-trigger ref="./fhir:period/fhir:end">
                                    <button>x</button>
                                    <fx-delete ref="./fhir:period/fhir:end"/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-trigger>
                            </div>
            	    	<fx-output ref="./fhir:timezone/@value"/>
                        <fx-output ref="./fhir:venue//fhir:priority/@value"/>
                        <fx-output ref="./fhir:venue//fhir:display/@value"/>
                        <fx-output ref="./fhir:note/fhir:text/@value"/>
                        <div>rendering</div>
                        <div>timing</div>
                    </fieldset>
                    <fieldset>
                    <legend>
                                                <label>Agendas</label>
                        <fx-trigger ref="instance('i-cal')[./fhir:schedule]">
                            <button>Neu</button>                                                                                                 
                            <fx-action>                                                         
                               <fx-insert position="before" at="1" ref="./schedule" context="instance('i-cal')" origin="instance('i-ical-infos')/bricks/schedule"/>
                            </fx-action>
                        </fx-trigger>
                    </legend>
                    <fx-repeat id="r-agenda" ref="./fhir:schedule">
<!--
                        <fx-action event="item-changed">
                            <fx-message>agenda: item-changed</fx-message>
                        </fx-action>
-->
                        <template>
                        <div>
                        <details>
                        <summary style="{if (exists(./fhir:period/fhir:end) and ./fhir:period/fhir:end/@value &lt; instance('default')/today) then 'background-color: rgba(180, 180, 70, 0.8); transform:skewX(-20deg)' else ''}">{if (./fhir:period/fhir:start) then substring(./fhir:period/fhir:start/@value,1,10) else '∞'} -&gt; {if (./fhir:period/fhir:end) then substring(./fhir:period/fhir:end/@value,1,10) else '∞'}
                            <fx-trigger class="iconbtn del">
                                <button>X</button>
                                <fx-action>
                                    <fx-delete ref="."/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-action>
                            </fx-trigger>
                        </summary>
                        <fieldset class="agenda">
                            <legend>
                                                                    <fx-output ref="./fhir:type/@value"/>
                                                                </legend>
                		    <div>
                		        <fx-control ref="./fhir:period/fhir:start/@value" update-event="input">
                                    <label for="a-start">Von</label>
            			            <input id="a-start" class="widget" type="date"/>
                	    		</fx-control>
                				<fx-trigger ref="./fhir:period[not(./fhir:start)]">
                                    <button>Von?</button>
                                    <fx-insert ref="./fhir:period/fhir:start" context="./fhir:period" origin="instance('helper')/fhir:period/fhir:start"/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-trigger>
            			        <fx-trigger ref="./fhir:period/fhir:start">
                                    <button>x</button>
                                    <fx-delete ref="./fhir:period/fhir:start"/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-trigger>
                            </div>
            	    		<div>
            		            <fx-control ref="./fhir:period/fhir:end/@value" update-event="input">
                                    <label for="a-end">Bis</label>
                		    	    <input id="a-end" class="widget" type="date"/>
                    			</fx-control>
            				    <fx-trigger ref="./fhir:period[not(./fhir:end)]">
                                    <button>Bis?</button>
                                    <fx-insert ref="./fhir:period/fhir:end" context="./fhir:period" origin="instance('helper')/fhir:period/fhir:end"/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-trigger>
            			    	<fx-trigger ref="./fhir:period/fhir:end">
                                    <button>x</button>
                                    <fx-delete ref="./fhir:period/fhir:end"/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-trigger>
            	    		</div>
            	    		<fx-output ref="./fhir:timezone/@value"/>
                            <fx-output ref="./fhir:venue//fhir:priority/@value"/>
                            <fx-output ref="./fhir:venue//fhir:display/@value"/>
                            <fx-output ref="./fhir:note/fhir:text/@value"/>
                            <div>rendering</div>
                            <div>timing</div>
                            </fieldset>

                        <fx-repeat id="r-event" class="event" ref="./fhir:event">
                            <fx-action event="event: item-changed">
                            </fx-action>
                            <template>
                            <div>
                            <details>
                            <summary>{./fhir:name/@value}</summary>
                            <div class="event settings">
                                <fx-control ref="./fhir:name/@value" update-event="input">
                                    <label for="e-name">Name</label>
    		    	                <input id="e-name" class="widget"/>
        			            </fx-control>
                                <fx-control ref="./fhir:start/@value" update-event="input">
                                    <label for="e-start">Von</label>
    		        	            <input id="e-start" class="widget" type="time"/>
        			            </fx-control>
                                <fx-control ref="./fhir:end/@value" update-event="input">
                                    <label for="e-end">Bis</label>
    		    	                <input id="e-end" class="widget" type="time"/>
            			        </fx-control>
            			    </div>
                            <details>
            	        	<summary>Note</summary>
		                        <fx-control ref="./fhir:note/fhir:text/@value">
                                    <textarea id="evt-note" cols="40" rows="4" class="widget"/>
                                </fx-control>
	                	    </details>
<!--
<details open="open">
    <summary id="rrule-summary">
        <span>{if (count(./rrule)=0) then "No " else " "}RRules</span>
        <fx-trigger ref=".[count(rrule)=0]" class="iconbtn">
                <button title="fügt RRule hinzu">+</button>
                <fx-action>
                    <fx-insert ref="./rrule" context="." origin="instance('i-ical-infos')/bricks/rrule"/>
                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                </fx-action>
        </fx-trigger>
        <fx-trigger ref=".[count(rrule)&gt;0]" class="iconbtn">
                <button title="löscht RRule">X</button>
                <fx-action>
                    <fx-delete ref="./rrule"/>
                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                </fx-action>
        </fx-trigger>
    </summary>
        <fx-group ref="./rrule" class="event settings">
            <fx-control id="rrule-freq" ref="./freq/@value" update-event="change">
                <label>Frequenz</label>
                <select class="widget" ref="instance('i-ical-infos')/rrule/freq">
                    <template>
                        <option value="{./@value}">{./@label}</option>
                    </template>
                </select>
            </fx-control>
            <fx-control id="rrule-week" ref="./byWeekNo/@value" update-event="input">
                <label>byWeek</label>
            </fx-control>
            <fx-control id="rrule-byday" ref="./byDay/@value" update-event="input">
                <label>byDay</label>
                <textarea col="40" rows="3" class="widget"/>
            </fx-control>
        </fx-group>

</details>
-->
<!--
<details>
    <summary>
        <span>{if (count(./rdate)=0) then "No " else ""}RDates</span>
        <fx-trigger ref=".[count(rdate)=0]" class="iconbtn">
                <button title="fügt RDate hinzu">+</button>
                <fx-action>
                    <fx-insert ref="./rdate" context="." origin="instance('i-ical-infos')/bricks/rdate"/>
                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                </fx-action>
        </fx-trigger>
        <fx-trigger ref=".[count(rdate)&gt;0]" class="iconbtn">
                <button title="löscht RDate">X</button>
                <fx-action>
                    <fx-delete ref="./rdate"/>
                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                </fx-action>
        </fx-trigger>
    </summary>
    <div>
                    <fx-repeat id="r-rdate" ref="./rdate/date">
                        <template>
                            <div>
    
                                <fx-control id="rdate-date" ref="./@value">
                                    <input type="date" class="widget"/>
                                </fx-control>
                                <fx-trigger class="iconbtn delRDate">
                                    <button>X</button>
                                    <fx-delete ref="."/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-trigger>
    
                            </div>
                        </template>
                    </fx-repeat>
                    <fx-trigger ref="./rdate" class="">
                        <button>Neu</button>
                        <fx-action>
                            <fx-insert at="1" position="before" ref="./date" context="." origin="instance('i-ical-infos')/bricks/rdate/date"/>
                            <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                            <fx-setfocus control="rdate-date"/>
                        </fx-action>
                    </fx-trigger>
    </div>
    </details>
-->
<!--
    <details>
    <summary>
        <span>{if (count(./exdate)=0) then "No " else " "}ExDates</span>
            <fx-trigger ref=".[count(exdate)=0]" class="iconbtn">
                <button title="fügt ExDate hinzu">+</button>
                <fx-action>
                    <fx-insert ref="./exdate" context="." origin="instance('i-ical-infos')/bricks/exdate"/>
                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                </fx-action>
            </fx-trigger>
            <fx-trigger ref=".[count(exdate)&gt;0]" class="iconbtn">
                <button title="löscht ExDate">X</button>
                <fx-action>
                    <fx-delete ref="./exdate"/>
                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                </fx-action>
            </fx-trigger>
    </summary>
    <div>
                    <fx-repeat id="r-exdate" ref="./exdate/date">
                        <template>
                            <fx-control ref="./@value">
                                <input id="exdate-date" type="date" class="widget"/>
                            </fx-control>
                            <fx-trigger class="iconbtn delRDate">
                                <button>X</button>
                                <fx-action>
                                    <fx-delete ref="."/>
                                    <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                                </fx-action>
                            </fx-trigger>
                        </template>
                    </fx-repeat>
                    <fx-trigger ref="./exdate">
                        <button>Neu</button>
                        <fx-action>
                            <fx-insert at="1" positiom="before" ref="./date" context="." origin="instance('i-ical-infos')/bircks/exdate/date"/>
                            <fx-setvalue ref="instance('i-control')/dirty">true</fx-setvalue>
                        </fx-action>
                    </fx-trigger>
    </div>
    </details>
-->
                        </details>
                        </div>
                        </template>
                        </fx-repeat>
                    </details>
                    </div>
                    </template>
                    </fx-repeat>
                    </fieldset>
                </div>
                <fx-trigger class="add" title="Organization löschen">
                    <iron-icon class="remove-icon-outline" title="Organization löschen"/>
                    <!--
                    <fx-delete>.</fx-delete>
                    <fx-refresh/>
                    -->
                </fx-trigger>
            </template>
        </fx-repeat>
        </fieldset>
        </details>
        </section>
    </fx-fore>
</div>
<fx-lens/>
</body>
</html>